{% extends "textbook_exchange/base.html" %}

{% block content %}
<head>
    <style>
        #page-container {
            min-width: 530px;
        }
        .buy-error-msg {
            height: 287px;
            padding: 90px 25px;
            font-size: 3vw;
        }
        .top {
            width: 100%; 
            margin-bottom: 20px; 
        }
        @media only screen and (max-width: 767px){
            .sidefilter-padding {
                padding: 10px;
            }
            #page-container {
                min-width: 0;
            }
        }
    </style>
</head>
<div class="container">
    <div class="row d-lg-none">
        <div class="input-group">
            <!-- Searchbar? -->
            <!-- TODO: Add searchbar on mobile only, and change behavior from search in menu -->
        </div>
    </div>
    {% if num_product_listings >= 0 %}
    <div class="row">
        <div class="showing-results">
            <h4><b>{{ textbook.title }}</b></h4>
            <p>{{ textbook.author_clean }}</p>
            <div class="cursor-pointer align-items-center justify-content-center" data-toggle="modal" data-target="#moreInfoModalCenter">
                <p class="btn btn-uva-secondary">More info</p>
            </div>
        </div>
    </div>
    {% endif %}
    {% if num_product_listings >= 1 %}
    <div class="row pb-2">
        <div class="col-3 offset-9">
            <div class="btn-group pull-right">
                <!-- SORT BY -->
                <button type="button" class="btn btn-light btn-sm dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    Sort by: {{ ordering }}
                </button>
                <form method="GET">
                    <div class="dropdown-menu">
                        <a href="?sort=price" class="dropdown-item">Price: Low to High</a>
                        <a href="?sort=-price" class="dropdown-item">Price: High to Low</a>
                        <a href="?sort=-published_date" class="dropdown-item">Most recent</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% endif %}
    <div class="row">
        {% if num_product_listings >= 1 %}
            <div class="col-md-3" style="padding-left: 0px;">
                <div id="searchFilters" style="width: max-content;">
                    <div class="card card-body mx-auto sidefilter-padding" style="margin-top: 0px;">
                        <div class="row mx-auto" style="padding: 10px;">
                            <form method="GET">
                                    <h5>Condition</h5>
                                    <div class="checkboxes" style="padding-left: 20px;">
                                        <input class="form-check-input" type="checkbox" value="likenew" id="likenew" checked>
                                        <label class="form-check-label" for="likenew">Like new</label>
                                        <br/>
                                        <input class="form-check-input" type="checkbox" value="verygood" id="verygood" checked>
                                        <label class="form-check-label" for="verygood">Very good</label>
                                        <br/>
                                        <input class="form-check-input" type="checkbox" value="" id="good" checked>
                                        <label class="form-check-label" for="good">Good</label>
                                        <br/>
                                        <input class="form-check-input" type="checkbox" value="acceptable" id="acceptable" checked>
                                        <label class="form-check-label" for="Acceptable">Acceptable</label>
                                    </div>
                                    <hr>
                                    <div class="row mt-4">
                                        <div class="col">                                        
                                            <h5 class="d-inline">Max Price</h5>
                                            <br/>
                                            <input type="number" id="maxPrice" name="quantity" min="0" max="500" class="form-control mt-3" style="width:100px;">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <input type="button" value="Apply" id="apply_filter" onClick="applyClick()" method="GET" class="btn btn-uva mt-4" style="margin: 0 60px;">
                                    </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
        <div class="mt-5 {% if num_product_listings >= 1 %}col-md-9{% else %}col-12{% endif %}">
            {% if num_product_listings == 0 %}
                <h3 class="text-center">
                    There are currently no listings for this textbook. Please try again later.
                </h3>
            {% elif num_product_listings > 0 %}
                <div class="row">
                    {% for listing in product_listings %}
                        <div class="card text-font mt-0" id="listing" style="width: 15rem;" price="{{ listing.price }}" condition="{{ listing.condition }}">
                            <div class="card-header">
                                <a href="{{ listing.picture_url }}" data-type="image" data-toggle="lightbox" data-max-width="700" id="{{ listing.isbn10 }}">
                                    <img class="card-img-top img-fluid" src="{{ listing.picture_url }}" alt="{{ listing.textbook.title }}" style="margin-top: 10px;">
                                </a>
                                <h5 class="card-title">{{ listing.textbook.title }}</h5>
                                <h6 class="card-subtitle mb-2 text-muted">{{ listing.textbook.author_clean }}</h6> 
                                <h5 class="card-subtitle mt-4 mb-2">${{ listing.price }}</h5>
                            </div>
                            <div class="card-body">
                                <h6 class="card-subtitle">{{ listing.user.first_name }} {{ listing.user.last_name }}</h6>
                                <a class="btn btn-outline-primary btn-sm mt-2" style="padding: 2px 10px;" href='javascript:createTwilio("{{listing.id}}", "{{listing.user.username}}", "{{user.username}}", "{{listing.textbook.title}}");'> 
                                    Message
                                </a>
                                <p class="card-subtitle mt-2 text-muted mb-4" style="font-size: smaller;">{{ listing.published_date }}</p>                                
                                <p class="card-subtitle mb-4">
                                    Condition:
                                    {% if listing.condition == "likenew" %}
                                        Like new
                                    {% elif listing.condition == "verygood" %}
                                        Very good
                                    {% elif listing.condition == "good" %}
                                        Good
                                    {% elif listing.condition == "acceptable" %}
                                        Acceptable
                                    {% endif %}
                                </p>
                                <p class="card-text mb-4">{{ listing.comments }}</p>
                                <a href="javascript:addtoCart({{ listing.id }});" id="add{{listing.id}}"
                                class="btn btn-primary d-block mx-auto" style="width: 55%;">
                                    Add to Cart
                                </a>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            <!-- NO TEXTBOOK SEARCHED -->
            {% else %}
                <h1 class="text-center">
                    Please search a textbook or a class in the search bar above to find listings
                </h1>
            {% endif %}
        </div>
    </div>
</div>

<script>
{% if search %}
    //updateSearch("{{ search }}");
    document.getElementById("search_text").value = "{{ search }}";
{% endif %}

function addtoCart(id) {
    console.log("add to cart working");
    $.ajax({
        url : "{% url 'payments:cart' %}",
        type: "POST",
        data: { 
            id : id,
            function: "add",
            csrfmiddlewaretoken: '{{ csrf_token }}'
        },
        success: function(json) {
            if (json['status'] == 'success') window.location.href = "{% url 'payments:cart' %}";
            else if (json['status'] == 'not_logged_in') window.location.href = "{% url 'exchange:login' %}" + "?login_redirect_target=/cart/";
        },
        error: function(xhr, errmsg, err) {
            console.log("error");
        },
    });
}

function applyClick() {
    event.preventDefault();

    var maxprice = document.getElementById('maxPrice').value;

    if (maxprice === "")
        maxprice = 500;
    else if (maxprice > 500)
        maxprice = 500;
    else if (maxprice < 0)
        maxprice = 0;

    var conditions_selected = [];
    if (document.getElementById('likenew').checked == true)
        conditions_selected.push("likenew");
    if (document.getElementById('verygood').checked == true)
        conditions_selected.push("verygood");
    if (document.getElementById('good').checked == true)
        conditions_selected.push("good");
    if (document.getElementById('acceptable').checked == true)
        conditions_selected.push("acceptable");

    $('.card').each(function() {
        $(this).show();

        var listing_condition = $(this).attr("condition");
        var listing_price = parseInt($(this).attr('price'));

        if ($(this).attr('id') == "listing") {
            if (listing_price > maxprice) // (this) == i in for loop
                $(this).hide();
            if (!conditions_selected.includes(listing_condition))
                $(this).hide();
        }
    });

};

$(document).on('click', '[data-toggle="lightbox"]', function(event) {
    event.preventDefault();
    console.log("clicked");
    console.log($(this));
    $(this).ekkoLightbox();
});

function truncateString(str, num) {
    // If the length of str is less than or equal to num
    // just return str--don't truncate it.
    if (str.length <= num) {
        return str;
    }
    // Return str truncated with '...' concatenated to the end of str.
    return str.slice(0, num);
}

function createTwilio(id, u1, u2, title) {
    {% if logged_in %}
        window.location.href = "{% url 'exchange:twilio' %}?listing_id="+id+"&seller_name="+u1+"&user_name="+u2+"&bname="+truncateString(title, 20);
    {% else %}
        window.location.href = "{% url 'exchange:login' %}" + "?login_redirect_target=" + window.location.href;
    {% endif %}
}

</script>


<div class="modal fade" id="moreInfoModalCenter" tabindex="-1" role="dialog" aria-labelledby="scanModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="moreInfoModalLongTitle">More Info</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <table class="table">
                    <tbody>
                        <tr>
                            <th scope="row">Bookstore ISBN</th>
                            <td>{{ textbook.bookstore_isbn }}</td>
                        </tr>
                        <tr>
                            <th scope="row">ISBN-10</th>
                            <td>{{ textbook.isbn10 }}</td>
                        </tr>
                        <tr>
                            <th scope="row">ISBN-13</th>
                            <td>{{ textbook.isbn13 }}</td>
                        </tr>
                        <tr>
                            <th scope="row">Bookstore New</th>
                            <td>{% if textbook.bookstore_new_price == 0.0 %}Not available{% else %}${{ textbook.bookstore_new_price }}{% endif %}</td>
                        </tr>
                        <tr>
                            <th scope="row">Bookstore Used</th>
                            <td>{% if textbook.bookstore_used_price == 0.0 %}Not available{% else %}${{ textbook.bookstore_used_price }}{% endif %}</td>
                        </tr>
                        <tr>
                            <th scope="row">Page Count</th>
                            <td>{{ textbook.page_count }} pages</td>
                        </tr>
                        <tr>
                            <th scope="row">Publisher</th>
                            <td>{{ textbook.publisher }}</td>
                        </tr>
                        <tr>
                            <th scope="row">Date Published</th>
                            <td>{{ textbook.date }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>   
    </div>
</div>

{% endblock content %}
